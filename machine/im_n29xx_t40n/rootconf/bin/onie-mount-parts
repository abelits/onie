#!/bin/sh

# Mount the ONIE partitions

. /lib/onie/functions

this_script=$(basename $(realpath $0))
lib_dir="$(dirname $(realpath $0))/../lib/onie"

[ -r "$lib_dir/onie-blkdev-common" ] || {
    echo "ERROR: Unable to find onie-blkdev-common"
    exit 1
}
. $lib_dir/onie-blkdev-common

args="wuvh"

usage()
{
    echo "usage: $this_script [-${args}]"
    cat <<EOF
Mount and un-mount ONIE partitions.

Only one of -w or -u can be specified.

COMMAND LINE OPTIONS

	The default is to mount BOOT partition read-write

	-h
		Help.  Print this message.

	-v
		Be verbose.  Print what is happening.

	-w
		Compatibility option -- Mount the ONIE-BOOT partition read-write.

		WARNING:  Do not use this option unless you really know
		what you are doing.  Only advisable when updating ONIE.

		Cannot be used with the -u option.

	-u
		Un-mount the ONIE partitions.  Cannot be used
		with the -w option.
EOF
}

rw=no
umount=no
verbose=no

while getopts "$args" a ; do
    case $a in
        h)
            usage
            exit 0
            ;;
        w)
            rw=yes
            ;;
        u)
            umount=yes
            ;;
        v)
            verbose=yes
            ;;
        *)
            echo "Unknown argument: $a"
            usage
            exit 1
    esac
done

if [ "$rw" = "yes" ] && [ "$umount" = "yes" ] ; then
    echo "ERROR: Only one of the -w or -u options can be specified."
    usage
    exit 1
fi

mount_parts()
{
    [ "$verbose" = "yes" ] && echo "Mounting $common_boot_mnt ..."
    onie_mount_partitions keep_mounted write
}

umount_parts()
{
    [ "$verbose" = "yes" ] && echo "Un-mounting $common_boot_mnt ..."
    onie_umount_partitions
}

if [ "$umount" = "yes" ] ; then
    umount_parts
else
    mount_parts
fi
