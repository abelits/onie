# dropbear config for x86_64 platforms

[ -r "/lib/onie/onie-blkdev-common" ] || {
    echo "ERROR: Unable to find onie-blkdev-common"
    exit 1
}
. /lib/onie/onie-blkdev-common

# The RSA and DSS keys are stored in the ONIE-CONFIG partition.  If
# the keys are missing generate the keys and store the results for
# future boots.
get_keys_arch() {
    onie_mount_partitions
    if [ -r "$onie_config_dir/$RSA_KEY" ] ; then
        cp "$onie_config_dir/$RSA_KEY" $RSA_KEY
    else
        onie_umount_partitions
        onie_mount_partitions write
        # genereate rsa key
        dropbearkey -t rsa -s 1024 -f $RSA_KEY > /dev/null 2>&1
        mkdir -p "$(dirname $onie_config_dir/$RSA_KEY)"
        cp $RSA_KEY "$onie_config_dir/$RSA_KEY"
        onie_umount_partitions
        onie_mount_partitions
    fi

    if [ -r "$onie_config_dir/$DSS_KEY" ] ; then
        cp "$onie_config_dir/$DSS_KEY" $DSS_KEY
    else
        # genereate dss key
        onie_umount_partitions
        onie_mount_partitions write
        dropbearkey -t dss -s 1024 -f $DSS_KEY > /dev/null 2>&1
        mkdir -p "$(dirname $onie_config_dir/$DSS_KEY)"
        cp $DSS_KEY "$onie_config_dir/$DSS_KEY"
        onie_umount_partitions
    fi
    onie_umount_partitions
}

